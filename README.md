# 📦 Day 4 – Idempotency and Retry Logic in Reactive Spring Boot

This is part of a structured learning series focused on building resilient APIs. In Day 4, we explore how to safely handle retries and prevent duplicate operations using `Idempotency-Key` support in a reactive wallet top-up API.

---

## 🎯 Use Case

You're building a wallet API where users can top up their balance. But what if:

* The user taps "Top Up" and the request times out?
* The app retries — was it already processed?

If retries are not handled correctly, users may be **charged twice**. We fix that.

---

## ✅ What This Project Demonstrates

* Reactive REST endpoint: `POST /api/wallet/topup`
* Accepts client-supplied `Idempotency-Key` header
* Uses an in-memory `ConcurrentHashMap` to detect duplicate requests
* Returns the **same response** for a duplicate key
* Designed to simulate real-world retry behavior

---

## 🧠 Why Idempotency Matters

In distributed systems, retries happen — network failures, timeouts, client crashes.
**Idempotency** ensures that:

* One unique user action = one server-side effect
* No duplicate operations are created by accident

---

## ⚙️ Tech Stack

* Java 17+
* Spring Boot 3.4.x
* Spring WebFlux
* ConcurrentHashMap (in-memory)
* Postman (for testing)

---

## 🚀 How to Run Locally

```bash
git clone https://github.com/atazifor/idempotency.git
cd idempotency
./mvnw spring-boot:run
```

Server runs on: `http://localhost:8080`

---

## 🧪 How to Test in Postman

### 🔁 First Request

```
POST http://localhost:8080/api/wallet/topup
```

### Headers:

```
Idempotency-Key: abc123
Content-Type: application/json
```

### Body:

```json
{
  "userId": "user1",
  "amount": 100.0
}
```

### Second Request (Retry)

Send the **same request again** with the same key. You’ll get the same response, marked:

```json
{
  "duplicate": true
}
```

---

## 🔐 What Is an Idempotency Key?

A **unique identifier** generated by the **client** at the start of a user action ("intent"). It ensures:

* 🔁 Retries return the same result
* 🧾 New keys = new user actions

### Key Rules

* **Same key** → retry
* **Different key** → new intent

### Intent Explained:

> A "user intent" is a deliberate action like tapping "Top Up" — it's not just about same payload, but same purpose.

If the user does the same top-up twice in the day, **use different keys**. If retrying due to a timeout, **use the same key**.

---

## 🧠 Why `ConcurrentHashMap`?

Spring Boot APIs are multi-threaded. A regular `HashMap` isn't thread-safe and can lead to race conditions.

We use `ConcurrentHashMap` to ensure:

* Atomic operations (put/check)
* Safe access under concurrent HTTP requests

---

## 💡 Maven Dependencies (WebFlux)

```xml
<dependencies>
    <dependency>
        <groupId>org.springframework.boot</groupId>
        <artifactId>spring-boot-starter-webflux</artifactId>
    </dependency>
    <dependency>
        <groupId>org.springframework.boot</groupId>
        <artifactId>spring-boot-starter</artifactId>
    </dependency>
    <dependency>
        <groupId>org.springframework.boot</groupId>
        <artifactId>spring-boot-starter-test</artifactId>
        <scope>test</scope>
    </dependency>
</dependencies>
```

---

## 🧩 RedisInsight & Kafka UI Access Notes

### 🔴 RedisInsight (Redis Visual Dashboard)

RedisInsight is included in the `docker-compose.yml` setup. To access:

- 🌐 **URL:** [http://localhost:5540](http://localhost:5540)
- 🛠️ **Redis Connection Settings:**
    - **Host:** `redis`
    - **Port:** `6379`
    - **Password:** *(leave blank)*

> RedisInsight and Redis are on the same Docker network, so `redis` resolves internally.

#### 🔍 What You Can Do in RedisInsight:
- View `rate:<userId>` keys for rate limiting
- View `idempotency:<id>` keys used for duplicate request prevention
- Inspect TTL countdowns
- Run CLI commands like `GET`, `TTL`, `INCR`, `EXPIRE`

---

### 🟡 Kafka UI (Topic & Message Browser)

Kafka UI is also included via Docker Compose. To access:

- 🌐 **URL:** [http://localhost:8085](http://localhost:8085)

#### 🔍 What You Can Do:
- View topics like `topup-events`
- See partition assignments and message offsets
- Manually produce or inspect messages
- Monitor Kafka broker health

---

### ✅ Start Everything

Make sure Docker is running, then launch all services with:

```bash
docker-compose up -d


---

## 📜 License

MIT — free to use, extend, and improve.
